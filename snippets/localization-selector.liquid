{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
LOCALIZATION SELECTOR COMPONENT - VironaX Enhanced
----------------------------------------------------------------------------------------------------------------------

This component renders a selector for a localization component (either country or locale).
Enhanced with: white background, proper styling, country ordering, flag support, and persistence.

********************************************
Supported variables
********************************************

* type: can be either "country" or "locale" (required)
* show_country_name: for type "country", if set to true the country name is shown
* show_country_flag: for type "country", if set to true the country flag is shown
* id_prefix: an option to help dissociate the ID in case this is included several times in the same section
{%- endcomment -%}

{%- capture localization_form_id -%}localization-form-{{ id_prefix }}-{{ section.id }}-{{ type }}{%- endcapture -%}
{%- capture localization_popover_id -%}popover-localization-{{ id_prefix }}-{{ section.id }}-{{ type }}{%- endcapture -%}

{%- comment -%}Define country order and data{%- endcomment -%}
{%- assign country_order = 'AE,SA,QA,BH,JO,KW,OM,TR,US,GB' | split: ',' -%}

{%- case type -%}
  {%- when 'country' -%}
    {%- comment -%}
    ----------------------------------------------------------------------------------------------
    COUNTRY SELECTOR - Enhanced with proper styling and ordering
    ----------------------------------------------------------------------------------------------
    {%- endcomment -%}

    <div class="relative vironax-localization-selector">
      <button type="button" class="localization-toggle vironax-localization-toggle heading text-xxs link-faded" aria-controls="{{ localization_popover_id }}" aria-label="{{ 'general.localization.change_country_accessibility_text' | t | escape }}" aria-expanded="false">
        {%- if show_country_flag -%}
          <span class="country-flag-emoji">
            {%- case localization.country.iso_code -%}
              {%- when 'AE' -%}ðŸ‡¦ðŸ‡ª
              {%- when 'SA' -%}ðŸ‡¸ðŸ‡¦
              {%- when 'QA' -%}ðŸ‡¶ðŸ‡¦
              {%- when 'BH' -%}ðŸ‡§ðŸ‡­
              {%- when 'JO' -%}ðŸ‡¯ðŸ‡´
              {%- when 'KW' -%}ðŸ‡°ðŸ‡¼
              {%- when 'OM' -%}ðŸ‡´ðŸ‡²
              {%- when 'TR' -%}ðŸ‡¹ðŸ‡·
              {%- when 'US' -%}ðŸ‡ºðŸ‡¸
              {%- when 'GB' -%}ðŸ‡¬ðŸ‡§
              {%- else -%}
                {{- localization.country | image_url: width: 60, format: 'jpg' | image_tag: class: 'country-flag' -}}
            {%- endcase -%}
          </span>
        {%- endif -%}

        {%- if show_country_name -%}
          <span class="vironax-country-display">
            {%- case localization.country.iso_code -%}
              {%- when 'AE' -%}United Arab Emirates (Ø¯.Ø¥ AED)
              {%- when 'SA' -%}Saudi Arabia (Ø±.Ø³ SAR)
              {%- when 'QA' -%}Qatar (Ø±.Ù‚ QAR)
              {%- when 'BH' -%}Bahrain ($ USD)
              {%- when 'JO' -%}Jordan ($ USD)
              {%- when 'KW' -%}Kuwait ($ USD)
              {%- when 'OM' -%}Oman ($ USD)
              {%- when 'TR' -%}TÃ¼rkiye (â‚º TRY)
              {%- when 'US' -%}United States ($ USD)
              {%- when 'GB' -%}United Kingdom (Â£ GBP)
              {%- else -%}
                {{ localization.country.name }} ({{ localization.country.currency.iso_code }} {% if localization.country.currency.symbol %}{{ localization.country.currency.symbol }}{%- endif -%})
            {%- endcase -%}
          </span>
        {%- else -%}
          <span class="vironax-currency-display">
            {%- case localization.country.iso_code -%}
              {%- when 'AE' -%}AED Ø¯.Ø¥
              {%- when 'SA' -%}SAR Ø±.Ø³
              {%- when 'QA' -%}QAR Ø±.Ù‚
              {%- when 'TR' -%}TRY â‚º
              {%- when 'GB' -%}GBP Â£
              {%- else -%}
                {{ localization.country.currency.iso_code }} {% if localization.country.currency.symbol %}{{ localization.country.currency.symbol }}{%- endif -%}
            {%- endcase -%}
          </span>
        {%- endif -%}

        {%- render 'icon' with 'chevron-down' -%}
      </button>

      <x-popover id="{{ localization_popover_id }}" initial-focus="[aria-selected='true']" class="popover popover--{{ placement | default: 'bottom-start' }} vironax-popover color-scheme color-scheme--dialog">
        <p class="h4 vironax-popover-header" slot="header">{{ 'general.localization.country' | t }}</p>

        {%- form 'localization', id: localization_form_id, class: 'vironax-localization-form' -%}
          <x-listbox class="popover__value-list vironax-country-list">
            {%- comment -%}First, render countries in our specified order{%- endcomment -%}
            {%- for ordered_code in country_order -%}
              {%- for country in localization.available_countries -%}
                {%- if country.iso_code == ordered_code -%}
                  {%- assign is_selected = false -%}
                  {%- if country.iso_code == localization.country.iso_code -%}
                    {%- assign is_selected = true -%}
                  {%- endif -%}

                  <button type="submit" name="country_code" class="popover__value-option vironax-country-option h-stack gap-2.5" role="option" value="{{ country.iso_code }}" aria-selected="{% if is_selected %}true{% else %}false{% endif %}" data-order="{{ forloop.parentloop.index }}">
                    <span class="country-flag-emoji vironax-flag">
                      {%- case country.iso_code -%}
                        {%- when 'AE' -%}ðŸ‡¦ðŸ‡ª
                        {%- when 'SA' -%}ðŸ‡¸ðŸ‡¦
                        {%- when 'QA' -%}ðŸ‡¶ðŸ‡¦
                        {%- when 'BH' -%}ðŸ‡§ðŸ‡­
                        {%- when 'JO' -%}ðŸ‡¯ðŸ‡´
                        {%- when 'KW' -%}ðŸ‡°ðŸ‡¼
                        {%- when 'OM' -%}ðŸ‡´ðŸ‡²
                        {%- when 'TR' -%}ðŸ‡¹ðŸ‡·
                        {%- when 'US' -%}ðŸ‡ºðŸ‡¸
                        {%- when 'GB' -%}ðŸ‡¬ðŸ‡§
                      {%- endcase -%}
                    </span>
                    <span class="vironax-country-name">
                      {%- case country.iso_code -%}
                        {%- when 'AE' -%}United Arab Emirates (Ø¯.Ø¥ AED)
                        {%- when 'SA' -%}Saudi Arabia (Ø±.Ø³ SAR)
                        {%- when 'QA' -%}Qatar (Ø±.Ù‚ QAR)
                        {%- when 'BH' -%}Bahrain ($ USD)
                        {%- when 'JO' -%}Jordan ($ USD)
                        {%- when 'KW' -%}Kuwait ($ USD)
                        {%- when 'OM' -%}Oman ($ USD)
                        {%- when 'TR' -%}TÃ¼rkiye (â‚º TRY)
                        {%- when 'US' -%}United States ($ USD)
                        {%- when 'GB' -%}United Kingdom (Â£ GBP)
                      {%- endcase -%}
                    </span>
                  </button>
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}

            {%- comment -%}Then, render any remaining countries not in our list{%- endcomment -%}
            {%- for country in localization.available_countries -%}
              {%- assign is_in_order = false -%}
              {%- for ordered_code in country_order -%}
                {%- if country.iso_code == ordered_code -%}
                  {%- assign is_in_order = true -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}

              {%- unless is_in_order -%}
                {%- assign is_selected = false -%}
                {%- if country.iso_code == localization.country.iso_code -%}
                  {%- assign is_selected = true -%}
                {%- endif -%}

                <button type="submit" name="country_code" class="popover__value-option vironax-country-option h-stack gap-2.5" role="option" value="{{ country.iso_code }}" aria-selected="{% if is_selected %}true{% else %}false{% endif %}" data-order="999">
                  {%- if show_country_flag -%}
                    {{- country | image_url: width: 60, format: 'jpg' | image_tag: loading: 'lazy', class: 'country-flag' -}}
                  {%- endif -%}
                  <span class="vironax-country-name">{{- country.name }} ({{ country.currency.iso_code }} {% if country.currency.symbol %}{{ country.currency.symbol }}{%- endif -%})</span>
                </button>
              {%- endunless -%}
            {%- endfor -%}
          </x-listbox>
        {%- endform -%}
      </x-popover>
    </div>

  {%- when 'locale' -%}
    {%- comment -%}
    ----------------------------------------------------------------------------------------------
    LOCALE SELECTOR - Enhanced styling
    ----------------------------------------------------------------------------------------------
    {%- endcomment -%}

    <div class="relative vironax-localization-selector">
      <button type="button" class="localization-toggle vironax-localization-toggle heading text-xxs link-faded" aria-controls="{{ localization_popover_id }}" aria-label="{{ 'general.localization.change_language_accessibility_text' | t | escape }}" aria-expanded="false">
        {{- localization.language.endonym_name | capitalize -}}
        {%- render 'icon' with 'chevron-down' -%}
      </button>

      <x-popover id="{{ localization_popover_id }}" initial-focus="[aria-selected='true']" class="popover popover--{{ placement | default: 'bottom-start' }} vironax-popover color-scheme color-scheme--dialog">
        <p class="h4 vironax-popover-header" slot="header">{{ 'general.localization.language' | t }}</p>

        {%- form 'localization', id: localization_form_id, class: 'vironax-localization-form' -%}
          <x-listbox class="popover__value-list vironax-locale-list">
            {%- for language in localization.available_languages -%}
              {%- assign is_selected = false -%}

              {%- if language.iso_code == localization.language.iso_code -%}
                {%- assign is_selected = true -%}
              {%- endif -%}

              <button type="submit" name="locale_code" class="popover__value-option vironax-locale-option" role="option" value="{{ language.iso_code }}" aria-selected="{% if is_selected %}true{% else %}false{% endif %}">
                {{- language.endonym_name | capitalize -}}
              </button>
            {%- endfor -%}
          </x-listbox>
        {%- endform -%}
      </x-popover>
    </div>
{%- endcase -%}

<style>
  /* VironaX Localization Selector Styles */

  /* Toggle Button Styling */
  .vironax-localization-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background-color: transparent;
    border: none;
    cursor: pointer;
    transition: opacity 0.3s ease, color 0.3s ease;
    font-family: var(--vironax-font, 'Montserrat', sans-serif);
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: inherit;
  }

  /* Header localization selectors - inherit text color */
  .header .vironax-localization-toggle,
  .header__secondary-nav .vironax-localization-toggle,
  .localization-selectors .vironax-localization-toggle,
  x-header .vironax-localization-toggle {
    color: currentColor;
  }

  .header .vironax-localization-toggle svg,
  .header__secondary-nav .vironax-localization-toggle svg,
  .localization-selectors .vironax-localization-toggle svg,
  x-header .vironax-localization-toggle svg {
    color: currentColor;
    fill: none;
    stroke: currentColor;
  }

  /* Transparent/dark header - white text */
  .header--transparent .vironax-localization-toggle,
  [data-transparent-header] .vironax-localization-toggle {
    color: #FFFFFF !important;
  }

  .header--transparent .vironax-localization-toggle svg,
  [data-transparent-header] .vironax-localization-toggle svg {
    color: #FFFFFF !important;
    stroke: #FFFFFF !important;
  }

  .vironax-localization-toggle:hover {
    opacity: 0.7;
  }

  .vironax-localization-toggle .country-flag-emoji {
    font-size: 16px;
    line-height: 1;
  }

  .vironax-localization-toggle .country-flag {
    width: 20px;
    height: 14px;
    object-fit: cover;
    border-radius: 2px;
  }

  /* Popover/Dropdown Styling - White Background */
  .vironax-popover {
    background-color: #FFFFFF !important;
    border: 1px solid #E5E5E5 !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12) !important;
    padding: 0 !important;
    min-width: 280px;
    max-height: 400px;
    overflow: hidden;
  }

  .vironax-popover-header {
    padding: 16px 20px;
    margin: 0;
    border-bottom: 1px solid #E5E5E5;
    font-family: var(--vironax-font, 'Montserrat', sans-serif);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #000000;
    background-color: #FFFFFF;
  }

  /* Country/Locale List */
  .vironax-country-list,
  .vironax-locale-list {
    max-height: 320px;
    overflow-y: auto;
    padding: 8px 0;
    background-color: #FFFFFF;
  }

  /* Custom scrollbar */
  .vironax-country-list::-webkit-scrollbar,
  .vironax-locale-list::-webkit-scrollbar {
    width: 6px;
  }

  .vironax-country-list::-webkit-scrollbar-track,
  .vironax-locale-list::-webkit-scrollbar-track {
    background: #F5F5F5;
  }

  .vironax-country-list::-webkit-scrollbar-thumb,
  .vironax-locale-list::-webkit-scrollbar-thumb {
    background: #CCCCCC;
    border-radius: 3px;
  }

  .vironax-country-list::-webkit-scrollbar-thumb:hover,
  .vironax-locale-list::-webkit-scrollbar-thumb:hover {
    background: #999999;
  }

  /* Option Buttons */
  .vironax-country-option,
  .vironax-locale-option {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 20px;
    background-color: #FFFFFF !important;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-family: var(--vironax-font, 'Montserrat', sans-serif);
    font-size: 13px;
    font-weight: 400;
    color: #333333;
    text-align: left;
  }

  .vironax-country-option:hover,
  .vironax-locale-option:hover {
    background-color: #F8F8F8 !important;
  }

  .vironax-country-option[aria-selected="true"],
  .vironax-locale-option[aria-selected="true"] {
    background-color: #F0F0F0 !important;
    font-weight: 500;
  }

  .vironax-country-option[aria-selected="true"]::after,
  .vironax-locale-option[aria-selected="true"]::after {
    content: 'âœ“';
    margin-left: auto;
    color: #000000;
    font-size: 14px;
  }

  /* Flag Styling */
  .vironax-flag {
    font-size: 20px;
    line-height: 1;
    flex-shrink: 0;
  }

  .vironax-country-option .country-flag {
    width: 24px;
    height: 16px;
    object-fit: cover;
    border-radius: 2px;
    flex-shrink: 0;
  }

  /* Country/Currency Name */
  .vironax-country-name,
  .vironax-country-display,
  .vironax-currency-display {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Smooth transitions */
  .vironax-popover {
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  /* Mobile Responsive */
  @media screen and (max-width: 699px) {
    .vironax-popover {
      min-width: 260px;
      max-width: calc(100vw - 40px);
    }

    .vironax-country-option,
    .vironax-locale-option {
      padding: 14px 16px;
      font-size: 14px;
    }

    .vironax-popover-header {
      padding: 14px 16px;
    }
  }

  /* RTL Support */
  [dir="rtl"] .vironax-country-option,
  [dir="rtl"] .vironax-locale-option {
    text-align: right;
    flex-direction: row-reverse;
  }

  [dir="rtl"] .vironax-country-option[aria-selected="true"]::after,
  [dir="rtl"] .vironax-locale-option[aria-selected="true"]::after {
    margin-left: 0;
    margin-right: auto;
  }

  /* Fix for Prestige theme integration */
  .popover.vironax-popover {
    --popover-background: #FFFFFF;
    --popover-border-color: #E5E5E5;
  }

  /* Ensure white background overrides any color scheme */
  .vironax-popover,
  .vironax-popover *,
  .vironax-country-list,
  .vironax-locale-list,
  .vironax-country-option,
  .vironax-locale-option,
  .vironax-popover-header {
    --background: 255 255 255 !important;
  }
</style>
